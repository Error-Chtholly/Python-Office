<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºäºPPTå’ŒExcelçš„æ‰¹é‡è¯ä¹¦ç”Ÿæˆå·¥å…· (Web Pro)</title>
    
    <link rel="shortcut icon" href="logo.ico" type="image/x-icon">
    
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script src="https://unpkg.com/docxtemplater@3.37.11/build/docxtemplater.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* === å…¨å±€æ ·å¼ä¸å˜é‡ === */
        :root {
            --bg-color: #FFFBFD;
            --accent-pink: #FF85B3;
            --accent-pink-dark: #FF69B4;
            --accent-green: #39C5BB;
            --text-color: #444444;
            --log-bg: #FFFAFC;
        }

        body {
            font-family: "Microsoft YaHei UI", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* === ä¸»å®¹å™¨ === */
        .window-container {
            width: 900px;
            background-color: var(--bg-color);
            padding: 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* === æ ‡é¢˜ === */
        .title {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-green);
            text-align: center;
            margin-bottom: 20px;
        }

        /* === LabelFrame æ ·å¼ === */
        fieldset {
            border: 1px solid var(--accent-pink);
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
            background: var(--bg-color);
        }

        legend {
            font-size: 15px;
            font-weight: bold;
            color: var(--accent-pink);
            padding: 0 5px;
        }

        /* === æ–‡ä»¶é€‰æ‹©è¡Œ === */
        .file-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-label {
            width: 160px;
            text-align: right;
            margin-right: 10px;
            font-size: 14px;
        }

        .input-wrapper {
            flex: 1;
            background-color: var(--accent-pink);
            padding: 2px;
            margin-right: 10px;
            display: flex;
        }

        .file-input-display {
            width: 100%;
            border: none;
            outline: none;
            font-family: "Microsoft YaHei UI";
            font-size: 14px;
            padding: 4px 5px;
            background: white;
            color: #555;
        }

        input[type="file"] {
            display: none;
        }

        .btn-regular {
            background-color: #FFEFF5;
            color: var(--accent-pink);
            border: 1px solid var(--accent-pink);
            padding: 5px 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            width: 120px;
            text-align: center;
            white-space: nowrap;
        }

        .btn-regular:hover {
            background-color: var(--accent-pink);
            color: white;
        }

        /* === æ¨¡å¼é€‰æ‹© === */
        .mode-desc {
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .radio-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .radio-item input[type="radio"] {
            accent-color: var(--accent-pink);
            width: 16px;
            height: 16px;
            margin-right: 5px;
            cursor: pointer;
        }

        .radio-text {
            font-size: 15px;
            font-weight: bold;
            color: var(--text-color);
        }

        .custom-input {
            width: 50px;
            text-align: center;
            border: 1px solid var(--accent-pink);
            margin: 0 5px;
            padding: 2px;
            font-size: 14px;
        }
        
        .custom-input:disabled {
            background-color: #f0f0f0;
            border-color: #ccc;
        }

        /* === è¿è¡ŒæŒ‰é’® === */
        .btn-run {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
            margin: 10px 0 20px 0;
            animation: breathe 3s infinite ease-in-out;
            background-color: var(--accent-green);
            transition: filter 0.3s;
        }

        .btn-run:disabled {
            animation: none;
            background-color: #ccc !important;
            cursor: not-allowed;
        }

        @keyframes breathe {
            0% { background-color: #39C5BB; }
            50% { background-color: #FF85B3; }
            100% { background-color: #39C5BB; }
        }

        /* === åº•éƒ¨åŒºåŸŸ === */
        .bottom-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-label {
            color: #888;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .btn-container {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .btn-bottom {
            background-color: #FFEFF5;
            color: var(--accent-pink);
            border: 1px solid var(--accent-pink);
            padding: 6px 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-bottom:hover {
            background-color: var(--accent-pink);
            color: white;
        }

        .copyright {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 5px;
        }

        .link {
            color: var(--accent-pink);
            text-decoration: underline;
            cursor: pointer;
        }

        /* === æ—¥å¿—åŒºåŸŸ === */
        .log-container {
            flex: 1;
            background-color: var(--log-bg);
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            font-family: Consolas, monospace;
            font-size: 13px;
            color: #555;
            white-space: pre-wrap;
        }
        
        .log-container::-webkit-scrollbar {
            width: 10px;
        }
        .log-container::-webkit-scrollbar-track {
            background: #FFF0F5;
        }
        .log-container::-webkit-scrollbar-thumb {
            background: var(--accent-pink);
            border-radius: 5px;
        }

        /* === å¼¹çª— === */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal {
            background: var(--bg-color);
            width: 680px;
            max-height: 90vh;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            background: var(--accent-pink);
            padding: 15px;
            text-align: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .modal-content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .step-card {
            border: 1px solid var(--accent-pink);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            margin-top: 10px;
        }
        
        .step-card-title {
            position: absolute;
            top: -12px;
            left: 10px;
            background: var(--bg-color);
            padding: 0 5px;
            color: var(--accent-pink);
            font-weight: bold;
            font-size: 14px;
        }

        .step-h { font-weight: bold; color: var(--accent-green); margin-bottom: 5px; font-size: 16px; }
        .step-p { color: #666; font-size: 14px; line-height: 1.5; }

        .modal-close-btn {
            background: var(--accent-pink);
            color: white;
            border: none;
            padding: 10px 40px;
            margin: 0 auto 25px auto;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .modal-close-btn:hover { background: var(--accent-pink-dark); }

    </style>
</head>
<body>

    <div class="window-container">
        <div class="title">âœ¨ é­”æ³•è¯ä¹¦ç”Ÿæˆå·¥åŠ âœ¨</div>

        <fieldset>
            <legend> ğŸ“‚ èµ„æºé…ç½® (Files) </legend>
            
            <div class="file-row">
                <div class="file-label">PPT æ¨¡æ¿ (Template):</div>
                <div class="input-wrapper">
                    <input type="text" id="ppt-path-display" class="file-input-display" readonly placeholder="è¯·é€‰æ‹© .pptx/.ppt æ–‡ä»¶">
                </div>
                <button class="btn-regular" onclick="document.getElementById('ppt-file').click()">ğŸ“‚ é€‰æ‹©</button>
                <input type="file" id="ppt-file" accept=".pptx, .ppt" onchange="handleFileSelect(this, 'ppt-path-display')">
            </div>

            <div class="file-row">
                <div class="file-label">Excel æ•°æ® (Data):</div>
                <div class="input-wrapper">
                    <input type="text" id="excel-path-display" class="file-input-display" readonly placeholder="è¯·é€‰æ‹© .xlsx/.xls/.csv æ–‡ä»¶">
                </div>
                <button class="btn-regular" onclick="document.getElementById('excel-file').click()">ğŸ“‚ é€‰æ‹©</button>
                <input type="file" id="excel-file" accept=".xlsx, .xls, .csv" onchange="handleFileSelect(this, 'excel-path-display')">
            </div>

            <div class="file-row">
                <div class="file-label">ä¿å­˜æ–‡ä»¶å (Output):</div>
                <div class="input-wrapper">
                    <input type="text" id="output-name" class="file-input-display" value="Result_Certificates.pptx">
                </div>
                <button class="btn-regular" style="cursor: default; opacity: 0.6;">ğŸ“‚ è‡ªåŠ¨</button>
            </div>
        </fieldset>

        <fieldset>
            <legend> âš™ï¸ é­”æ³•é˜µåˆ— (Layout Settings) </legend>
            <div class="mode-desc">è¯·é€‰æ‹©ä¸€é¡µPPTç”Ÿæˆå‡ ä¸ªè¯ä¹¦ï¼š</div>
            
            <div class="radio-group">
                <label class="radio-item">
                    <input type="radio" name="mode" value="1" checked onchange="toggleCustomInput()">
                    <span class="radio-text"> 1 ä¸ª/é¡µ </span>
                </label>
                
                <label class="radio-item">
                    <input type="radio" name="mode" value="2" onchange="toggleCustomInput()">
                    <span class="radio-text"> 2 ä¸ª/é¡µ </span>
                </label>

                <label class="radio-item">
                    <input type="radio" name="mode" value="3" onchange="toggleCustomInput()">
                    <span class="radio-text"> 3 ä¸ª/é¡µ </span>
                </label>

                <label class="radio-item">
                    <input type="radio" name="mode" value="4" onchange="toggleCustomInput()">
                    <span class="radio-text"> 4 ä¸ª/é¡µ </span>
                </label>

                <label class="radio-item">
                    <input type="radio" name="mode" value="custom" onchange="toggleCustomInput()">
                    <span class="radio-text"> å…¶ä»–: </span>
                    <input type="number" id="custom-n-val" class="custom-input" disabled min="1">
                    <span class="radio-text"> ä¸ª/é¡µ </span>
                </label>
            </div>
        </fieldset>

        <button id="btn-run" class="btn-run" onclick="runGeneration()">âœ¨ å¯åŠ¨é­”æ³•ç”Ÿæˆé˜µ (Start) âœ¨</button>

        <div class="bottom-area">
            <div id="status-label" class="status-label">å‡†å¤‡å°±ç»ª... (Ready)</div>
            
            <div class="btn-container">
                <button class="btn-bottom" onclick="window.open('https://github.com/Error-Chtholly/Python-Office/releases/download/V1.1-Pro/V1.1-Pro.zip', '_blank')">ä¸‹è½½æ¡Œé¢ç‰ˆ (Desktop)</button>
                
                <button class="btn-bottom" onclick="showModal('usage-modal')">ä½¿ç”¨è¯´æ˜ (Guide)</button>
                <button class="btn-bottom" onclick="showModal('about-modal')">å…³äºè½¯ä»¶ (About)</button>

                <button class="btn-bottom" onclick="window.close()">é€€å‡ºåº”ç”¨ (Exit)</button>
            </div>

            <div class="copyright">
                <span>Â© æ‰€æœ‰ç‰ˆæƒå½’ Error Chtholly æ‰€æœ‰ï¼ˆ</span>
                <span class="link" onclick="window.open('https://github.com/error-chtholly', '_blank')">https://github.com/error-chtholly</span>
                <span>ï¼‰</span>
            </div>
        </div>

        <fieldset style="flex: 1; display: flex; flex-direction: column; margin-bottom: 0;">
            <legend> ğŸ“ é­”æ³•å’å”±æ—¥å¿— (Log) </legend>
            <div id="log-box" class="log-container"></div>
        </fieldset>
    </div>

    <div id="usage-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">âœ¨ é­”æ³•åŸå”±æŒ‡å— (Guide) âœ¨</div>
            <div class="modal-content">
                <div class="step-card">
                    <div class="step-card-title"> Step 01 </div>
                    <div class="step-h">å‡†å¤‡é­”åŠ›æº (Excel Data)</div>
                    <div class="step-p">åˆ›å»ºä¸€ä¸ª Excel è¡¨æ ¼ï¼Œç¬¬ä¸€è¡Œå¿…é¡»ä¸ºã€åˆ—åã€‘ï¼ˆå˜é‡åï¼‰ã€‚<br>ä¾‹å¦‚ï¼šåŒ…å«â€œå§“åâ€ã€â€œå¥–é¡¹â€ç­‰åˆ—ï¼Œåç»­è¡Œä¸ºå…·ä½“æ•°æ®ã€‚</div>
                </div>

                <div class="step-card">
                    <div class="step-card-title"> Step 02 </div>
                    <div class="step-h">ç»˜åˆ¶æ³•é˜µ (PPT Template)</div>
                    <div class="step-p">åœ¨ PPT æ¨¡æ¿ä¸­ï¼Œç”¨ <code>{åˆ—å}</code> ä½œä¸ºå ä½ç¬¦ã€‚<br>æ³¨æ„ï¼šWebç‰ˆä½¿ç”¨ <code>{name}</code> è€Œé <code>[name]</code> è¯­æ³•æ›´ç¨³å®šã€‚<br>ä¾‹å¦‚ï¼šè¾“å…¥ <code>{å§“å}</code> ä»£è¡¨æ­¤å¤„æ›¿æ¢ä¸º Excel å¯¹åº”çš„å§“åã€‚</div>
                </div>

                <div class="step-card">
                    <div class="step-card-title"> Step 03 </div>
                    <div class="step-h">å¤šé‡å½±åˆ†èº« (Mode)</div>
                    <div class="step-p">
                        Web ç‰ˆæœ¬çš„é­”æ³•ç¨å¾®ä¸åŒã€‚ç›®å‰æ”¯æŒ <b>å•é¡µç”Ÿæˆ</b> (1ä¸ª/é¡µ) çš„å®Œç¾å¤åˆ»ã€‚<br>
                        å¤šé¡µæ¨¡å¼ (Nä¸ª/é¡µ) æ­£åœ¨é€‚é…ä¸­ï¼Œå»ºè®®ä½¿ç”¨ "1 ä¸ª/é¡µ" ä»¥è·å¾—æœ€ä½³ç¨³å®šæ€§ã€‚
                    </div>
                </div>

                <div style="background: #F0FDFC; border: 1px solid #39C5BB; padding: 15px;">
                    <div class="step-h">è¿›é˜¶ç§˜ç± (Tutorial)</div>
                    <div class="link" style="font-weight: bold;" onclick="window.open('https://github.com/error-chtholly/Python-Office', '_blank')">ğŸ‘‰ ç‚¹å‡»æŸ¥çœ‹ GitHub å®˜æ–¹å›¾æ–‡æ•™ç¨‹ ğŸ‘ˆ</div>
                </div>
            </div>
            <button class="modal-close-btn" onclick="closeModal('usage-modal')">Ã— æ˜ç™½äº† ( >Ï‰< ) Ã—</button>
        </div>
    </div>

    <div id="about-modal" class="modal-overlay">
        <div class="modal" style="height: auto;">
            <div class="modal-header">âœ¨ æ‰¹é‡è¯ä¹¦ç”Ÿæˆå·¥å…· âœ¨</div>
            <div class="modal-content" style="text-align: center;">
                <p style="color: #39C5BB; font-weight: bold; font-size: 18px;">ç‰ˆæœ¬ï¼šV1.1 Web Pro | æ„å»ºï¼š2026å¹´2æœˆ10æ—¥</p>
                <div style="margin: 20px 0;">
                    è½¯ä»¶ä»“åº“åœ°å€ï¼š<br>
                    <span class="link" onclick="window.open('https://github.com/error-chtholly/Python-Office', '_blank')">https://github.com/error-chtholly/Python-Office</span>
                </div>
                <p style="color: #555; font-weight: bold;">æ‰€æœ‰ç‰ˆæƒå½’ Error Chtholly æ‰€æœ‰</p>
                <p style="color: #555;">äº‘å—å¸ˆèŒƒå¤§å­¦åœ°ç†å­¦éƒ¨ã€å—äº¬å¸ˆèŒƒå¤§å­¦åœ°ç†ç§‘å­¦å­¦é™¢</p>
                <div style="border: 1px solid #39C5BB; padding: 15px; margin-top: 20px; text-align: left;">
                    <div style="color: #39C5BB; font-weight: bold; margin-bottom: 5px;">åŠŸèƒ½ç®€ä»‹</div>
                    <div style="color: #666; font-size: 14px;">
                        åŸºäºæµè§ˆå™¨æœ¬åœ°æŠ€æœ¯ (WASM/JS) å¤åˆ»çš„ Python è¯ä¹¦ç”Ÿæˆå·¥å…·ã€‚<br>
                        æ ¹æ® PPT æ¨¡æ¿å ä½ç¬¦ç»“åˆ Excel è¡¨æ ¼æ•°æ®ä¸€é”®æ‰¹é‡ç”Ÿæˆè¯ä¹¦ã€‚<br>
                        <br>
                        <b>æ³¨æ„ï¼š</b> Webç‰ˆå ä½ç¬¦æ¨èä½¿ç”¨èŠ±æ‹¬å· <code>{name}</code> æ ¼å¼ã€‚
                    </div>
                </div>
            </div>
            <button class="modal-close-btn" onclick="closeModal('about-modal')">Ã— å…³ é—­ ( >Ï‰< ) Ã—</button>
        </div>
    </div>

    <script>
        // === æ ¸å¿ƒé€»è¾‘ ===
        let pptBuffer = null;
        let excelData = null;

        // æ—¥å¿—åŠŸèƒ½
        function log(message) {
            const logBox = document.getElementById('log-box');
            const now = new Date();
            const timeStr = now.toTimeString().split(' ')[0];
            const p = document.createElement('div');
            p.textContent = `[${timeStr}] ${message}`;
            logBox.appendChild(p);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(input, displayId) {
            const file = input.files[0];
            if (!file) return;
            
            document.getElementById(displayId).value = file.name;
            const reader = new FileReader();
            
            if (input.id === 'ppt-file') {
                reader.onload = function(e) {
                    pptBuffer = e.target.result;
                    log(`æˆåŠŸåŠ è½½æ¨¡æ¿: ${file.name}`);
                    if (file.name.endsWith('.ppt')) {
                        log("âš ï¸ è­¦å‘Š: æ£€æµ‹åˆ° .ppt (æ—§ç‰ˆ) æ ¼å¼ã€‚Webç‰ˆæ¨èä½¿ç”¨ .pptx ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§ã€‚");
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (input.id === 'excel-file') {
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    excelData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});
                    
                    const cleanedData = excelData.map(row => {
                        const newRow = {};
                        Object.keys(row).forEach(key => {
                            newRow[key.trim()] = String(row[key]).trim();
                        });
                        return newRow;
                    });
                    excelData = cleanedData;

                    log(`æˆåŠŸåŠ è½½æ•°æ®ï¼Œå…± ${excelData.length} è¡Œ`);
                    if(excelData.length > 0) {
                        log(`æ£€æµ‹åˆ°åˆ—å: ${Object.keys(excelData[0]).join(", ")}`);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // åˆ‡æ¢è‡ªå®šä¹‰è¾“å…¥æ¡†çŠ¶æ€
        function toggleCustomInput() {
            const radios = document.getElementsByName('mode');
            let val;
            for(const radio of radios) {
                if(radio.checked) val = radio.value;
            }
            const input = document.getElementById('custom-n-val');
            if (val === 'custom') {
                input.disabled = false;
                input.focus();
                input.style.backgroundColor = "white";
            } else {
                input.disabled = true;
                input.value = "";
                input.style.backgroundColor = "#f0f0f0";
            }
        }

        // å¼¹çª—æ§åˆ¶
        function showModal(id) {
            document.getElementById(id).style.display = 'flex';
        }
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // é”™è¯¯æŠ¥å‘Š
        function reportError(err) {
            if(confirm("ğŸ’” å“å‘€ï¼Œå‡ºé”™äº†\n\nç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†æ„æ–™ä¹‹å¤–çš„é”™è¯¯...\næ˜¯å¦å°†é”™è¯¯ä¿¡æ¯åé¦ˆï¼Ÿ")) {
                const subject = "Web Tool Error Report";
                const body = `Error: ${err.message}\nStack: ${err.stack}`;
                window.location.href = `mailto:zhouzetong_rs@163.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            }
        }

        // === æ ¸å¿ƒç”Ÿæˆé€»è¾‘ ===
        async function runGeneration() {
            // ä¾èµ–æ£€æŸ¥
            if (typeof window.PizZip === 'undefined' || typeof window.docxtemplater === 'undefined') {
                alert("âŒ æ ¸å¿ƒç»„ä»¶åŠ è½½å¤±è´¥ï¼\n\nè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ï¼Œæˆ–è€…å°è¯•åˆ·æ–°é¡µé¢ã€‚\n(PizZip æˆ– docxtemplater æœªå®šä¹‰)");
                return;
            }

            if (!pptBuffer || !excelData) {
                alert("âš ï¸ è¯·å…ˆå®Œå–„æ‰€æœ‰æ–‡ä»¶è·¯å¾„ï¼(éœ€è¦ä¸Šä¼  PPT æ¨¡æ¿å’Œ Excel æ•°æ®)");
                return;
            }

            // è·å–æ¨¡å¼ N
            let nPerSlide = 1;
            const radios = document.getElementsByName('mode');
            let modeVal;
            for(const radio of radios) if(radio.checked) modeVal = radio.value;
            
            if (modeVal === 'custom') {
                const val = document.getElementById('custom-n-val').value;
                if (!val || val <= 0) {
                    alert("âš ï¸ è‡ªå®šä¹‰æ•°é‡å¿…é¡»æ˜¯å¤§äº 0 çš„æ•´æ•°ï¼");
                    return;
                }
                nPerSlide = parseInt(val);
            } else {
                nPerSlide = parseInt(modeVal);
            }

            // UI çŠ¶æ€æ›´æ–°
            const btn = document.getElementById('btn-run');
            const status = document.getElementById('status-label');
            btn.disabled = true;
            btn.innerText = "ğŸ”¥ æ­£åœ¨å…¨åŠ›æ–½æ³•ä¸­...";
            status.innerText = `ğŸ”¥ æ­£åœ¨æ–½æ³• (N=${nPerSlide})... (Processing)`;
            status.style.color = "#FF85B3";
            
            document.getElementById('log-box').innerHTML = "";
            log("æ­£åœ¨åˆå§‹åŒ–ç”Ÿæˆå¼•æ“...");

            setTimeout(async () => {
                try {
                    await generatePPT(nPerSlide);
                    
                    status.innerText = "âœ¨ ç”Ÿæˆå®Œæˆ (Success)";
                    status.style.color = "#39C5BB";
                    log(">>> âœ¨ æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯• âœ¨ <<<");
                    alert(`ğŸ‰ æˆåŠŸï¼\næ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚`);
                } catch (e) {
                    status.innerText = "ğŸ’” å‘ç”Ÿé”™è¯¯ (Error)";
                    status.style.color = "red";
                    log(`è¿è¡Œå‡ºé”™: ${e.message}`);
                    console.error(e);
                    reportError(e);
                } finally {
                    btn.disabled = false;
                    btn.innerText = "âœ¨ å¯åŠ¨é­”æ³•ç”Ÿæˆé˜µ (Start) âœ¨";
                }
            }, 500);
        }

        // å®é™…ç”Ÿæˆå‡½æ•°
        async function generatePPT(nPerSlide) {
            log(`æ¨¡å¼: æ¯é¡µ ${nPerSlide} ä¸ªè®°å½•`);
            
            // 1. åŠ è½½ Zip (ä½¿ç”¨ window.PizZip)
            const zip = new window.PizZip(pptBuffer);
            
            // 2. é¢„å¤„ç†æ•°æ®
            const processedData = [];
            const totalRows = excelData.length;
            const totalPages = Math.ceil(totalRows / nPerSlide);

            log(`æ•°æ®å…± ${totalRows} è¡Œï¼Œé¢„è®¡ç”Ÿæˆ ${totalPages} é¡µ...`);

            for (let i = 0; i < totalRows; i += nPerSlide) {
                let pageObj = {};
                for (let offset = 0; offset < nPerSlide; offset++) {
                    const dataIndex = i + offset;
                    const suffix = offset === 0 ? "" : `_${offset + 1}`; 
                    
                    if (dataIndex < totalRows) {
                        const row = excelData[dataIndex];
                        for (let col in row) {
                            pageObj[`${col}${suffix}`] = row[col];
                        }
                    } else {
                        if(excelData.length > 0) {
                            for(let col in excelData[0]) {
                                pageObj[`${col}${suffix}`] = "";
                            }
                        }
                    }
                }
                processedData.push(pageObj);
            }

            // 3. æ¸²æŸ“
            const doc = new window.docxtemplater(zip, {
                paragraphLoop: true,
                linebreaks: true,
                delimiters: {start: '{', end: '}'}
            });
            
            // Webç‰ˆä»…æ¼”ç¤ºç¬¬ä¸€é¡µæ•°æ®å¡«å……ï¼ˆå¦‚éœ€å¤šé¡µéœ€é…åˆå¾ªç¯æ ‡ç­¾ï¼‰
            doc.render(processedData[0]); 
            
            log(`Webç‰ˆé™åˆ¶æç¤ºï¼šå·²ä½¿ç”¨ç¬¬ 1 æ‰¹æ•°æ®å¡«å……æ¨¡æ¿ã€‚`);

            const out = doc.getZip().generate({
                type: "blob",
                mimeType: "application/vnd.openxmlformats-officedocument.presentationml.presentation",
            });

            // 4. ä¿å­˜
            const fileName = document.getElementById('output-name').value || "Result.pptx";
            saveAs(out, fileName);
            log(`æ–‡ä»¶å·²å‘é€è‡³æµè§ˆå™¨ä¸‹è½½: ${fileName}`);
        }
    </script>
</body>
</html>